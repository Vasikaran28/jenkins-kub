pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t jenkinscontainer07.azurecr.io/python-app:v1 .'
            }
        }

        stage('Login to Azure and ACR') {
            steps {
                script {
                    // Login to Azure using Service Principal
                    sh 'az login --service-principal --username <SP-APP-ID> --password <SP-PASSWORD> --tenant <TENANT-ID>'
                    // Set the Azure subscription
                    sh 'az account set --subscription 9f25e6a7-b97d-4ae6-8200-eb5a6628f5e9'
                    // Login to Azure Container Registry
                    sh 'az acr login --name jenkinscontainer07'
                }
            }
        }

        stage('Push to ACR') {
            steps {
                sh 'docker push jenkinscontainer07.azurecr.io/python-app:v1'
            }
        }

        stage('Install kubectl') {
            steps {
                sh 'az aks install-cli'  // Install kubectl
                sh 'kubectl version --client'  // Verify kubectl installation
            }
        }

        stage('Deploy to AKS') {
            steps {
                script {
                    // Get AKS credentials
                    sh 'az aks get-credentials --resource-group kub_rg --name jenkins_kub_testing --overwrite-existing'
                    // Apply the Kubernetes deployment configuration
                    sh 'kubectl apply -f k8s/deployment.yaml'
                }
            }
        }
    }

    post {
        always {
            // Cleanup - Remove the Docker image after deployment
            sh 'docker rmi jenkinscontainer07.azurecr.io/python-app:v1'
        }
    }
}
